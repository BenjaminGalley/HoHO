<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Jungle Game | HoHoHo Bet</title>
<link rel="stylesheet" href="style.css">
<style>
body{margin:0;padding:0;font-family:sans-serif;background:#0b3d0b;color:#fff;overflow:hidden}
.top-bar{display:flex;justify-content:space-between;padding:10px;background:#144214;border-bottom:3px solid #ffcc33}
.top-info span{margin-right:15px;font-weight:bold;font-size:16px}
.top-actions button,a{margin-left:10px;color:#fff;text-decoration:none;background:#111;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;font-weight:bold}

.game-container{position:relative;width:100%;height:70vh;overflow:hidden;padding:20px;background-image:url('assets/jungle.background.jpg');background-size:cover;background-position:center}
.grid-container{display:grid;grid-template-columns:repeat(4,1fr);grid-gap:10px;width:70%;float:left}
.grid-item{width:100%;height:100px;background:#111;border-radius:10px;display:flex;justify-content:center;align-items:center;cursor:pointer;transition:0.3s}
.grid-item.selected{border:3px solid #ffcc33}
.bet-panel{float:left;width:25%;padding-left:20px}
.bet-panel h3{margin-top:0}
.bet-panel button{padding:10px 20px;margin:5px;font-size:18px;border:none;border-radius:5px;background:#ffcc33;color:#000;cursor:pointer;font-weight:bold;transition:0.2s}
.bet-panel button:hover{transform:scale(1.05)}
.ticket-board{clear:both;margin-top:20px;max-height:200px;overflow-y:auto}
.ticket{background:#111;padding:10px;margin-bottom:10px;border-radius:10px}
</style>
</head>
<body>

<div class="top-bar">
  <div class="logo">Jungle Game</div>
  <div class="top-info">
    <span id="playerIdDisplay"></span>
    <span id="balanceDisplay"></span>
  </div>
  <div class="top-actions">
    <a href="index.html">Lobby</a>
    <button onclick="logoutUser()">Logout</button>
  </div>
</div>

<div class="game-container">
  <div class="grid-container" id="gameGrid"></div>
  <div class="bet-panel">
    <h3>Bet Panel</h3>
    <div>Selected: <span id="selectedAnimals"></span></div>
    <div>Bet: <span id="betAmount">2</span> Birr</div>
    <button onclick="changeBet(-1)">âˆ’</button>
    <button onclick="changeBet(1)">+</button>
    <button onclick="placeBet()">Place Bet</button>
  </div>
</div>

<div class="ticket-board" id="ticketBoard"></div>

<audio id="clickSound" src="assets/click.mp3"></audio>
<audio id="winSound" src="assets/pop.mp3"></audio>

<script>
if(!user) location.href="login.html";

/* Config */
const clickSound=document.getElementById("clickSound");
const winSound=document.getElementById("winSound");
const animals=["lion.jpg","zebra.jpg","tiger.jpg","hippo.jpg","elephant.jpg","giraffe.jpg"];
const grid=document.getElementById("gameGrid");
const ticketBoard=document.getElementById("ticketBoard");
const googleScriptURL="https://script.google.com/macros/s/AKfycbxf_AZ6uJO5BuW9y0M9EuUjF1ZKphqcLG6SeE5DtOORxusuMosjbEvqUiv7tsd4JVfAdA/exec";

let selected=[];
let bet=2;
let balance=Number(localStorage.getItem("balance")||0);
let tickets=[];

/* Top bar */
function updateTopBar(){
  document.getElementById("playerIdDisplay").innerText="ID: "+user.id;
  document.getElementById("balanceDisplay").innerText="Balance: "+balance+" Birr";
}
updateTopBar();

/* Build 4x4 grid */
for(let i=0;i<16;i++){
  const div=document.createElement("div");
  div.className="grid-item";
  const img=document.createElement("img");
  img.src="assets/"+animals[i%animals.length];
  img.style.width="80px";
  img.style.height="80px";
  div.appendChild(img);
  div.onclick=()=>{toggleSelect(div,i);clickSound.play();}
  grid.appendChild(div);
}

/* Select / deselect */
function toggleSelect(el,index){
  if(selected.includes(index)){
    selected=selected.filter(x=>x!==index);
    el.classList.remove("selected");
  }else{
    if(selected.length>=5) return; // max 5
    selected.push(index);
    el.classList.add("selected");
  }
  document.getElementById("selectedAnimals").innerText=selected.map(i=>animals[i]).join(", ");
}

/* Bet adjustment */
function changeBet(v){
  bet=Math.max(2,bet+v);
  document.getElementById("betAmount").innerText=bet;
  clickSound.play();
}

/* Place bet */
function placeBet(){
  if(selected.length===0)return alert("Select animals");
  if(balance<bet)return alert("Low balance");

  balance-=bet;
  localStorage.setItem("balance",balance);
  updateTopBar();

  // Calculate random result & win
  const resultIndices=[];
  for(let i=0;i<16;i++) resultIndices.push(Math.floor(Math.random()*animals.length));
  let winCount=selected.filter(i=>resultIndices[i]%animals.length===i%animals.length).length;
  let winAmount=winCount*bet*2; // standard casino payout formula
  balance+=winAmount;
  localStorage.setItem("balance",balance);
  updateTopBar();
  if(winAmount>0) winSound.play();

  const ticket={id:Date.now(),selected:[...selected],bet,win:winAmount};
  tickets.push(ticket);
  renderTickets();

  selected=[];
  document.querySelectorAll(".grid-item").forEach(g=>g.classList.remove("selected"));
  document.getElementById("selectedAnimals").innerText="";

  // Update Google Script
  fetch(googleScriptURL,{
    method:"POST",
    body:JSON.stringify({action:"updateBalance",playerId:user.id,balance}),
    headers:{"Content-Type":"application/json"}
  }).then(r=>r.json()).then(console.log).catch(console.error);
}

/* Render tickets */
function renderTickets(){
  ticketBoard.innerHTML="";
  tickets.forEach(tc=>{
    const div=document.createElement("div");
    div.className="ticket";
    div.innerHTML=`#${tc.id}<br>Selected: ${tc.selected.map(i=>animals[i]).join(", ")}<br>Bet: ${tc.bet} Birr<br>Win: ${tc.win}`;
    ticketBoard.appendChild(div);
  });
}

/* Logout */
function logoutUser(){
  localStorage.removeItem("user");
  location.href="login.html";
}
</script>

</body>
</html>
